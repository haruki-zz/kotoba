# 架构概览

## 当前目录结构与职责
- `package.json`: npm 清单，设定 ES module、私有包标记与 dev/build/build:desktop/lint/format/test 脚本，配置 electron-builder 产物与 Electron 主入口（ESM），`npm test` 使用 Vitest。
- `package-lock.json`: 锁定依赖版本，确保安装结果可复现。
- `.gitignore`: 忽略 `node_modules`、打包产物与本地环境变量，保持仓库整洁与密钥安全。
- `.env.local`: 本地密钥占位文件（OpenAI/Google），避免后续读取缺失变量时报错，实际值不入库。
- `eslint.config.js`: ESLint flat 配置，组合 typescript-eslint、React/React Hooks 规则并套用 Prettier，忽略构建与依赖目录。
- `.prettierrc` / `.prettierignore`: 统一 Prettier 代码风格与忽略列表，避开构建产物与锁文件。
- `tsconfig.json`: TypeScript 严格配置，启用 React JSX/DOM 库，noEmit 仅做类型检查。
- `vite.config.ts`: Vite 与 `vite-plugin-electron` 配置，分别构建 renderer（`dist/renderer`）与 Electron 主/预加载（`dist-electron`，主进程输出 ESM `index.mjs`，预加载输出 CJS），内置 Vitest 配置（Node 环境，匹配 `src/__test__`）。
- `index.html`: 渲染进程入口，挂载 React 根节点并加载 `src/renderer/main.tsx`。
- `src/main/index.ts`: Electron 主进程入口，创建窗口、加载 dev/prod 资源，预设安全选项（contextIsolation=true、nodeIntegration=false）。
- `src/main/ai/index.ts`: AI 适配入口，根据配置构建 OpenAI/Gemini/Mock provider，统一生成词卡接口。
- `src/main/ai/openai.ts`: OpenAI provider，使用 chat completions 非流式 JSON 输出（默认 gpt-4o-mini），支持超时与最大 tokens 限制。
- `src/main/ai/gemini.ts`: Gemini provider，使用 Flash 2.5 Lite 预览模型 JSON 输出，透传超时并限制输出 tokens。
- `src/main/ai/mock.ts`: Mock provider，用于无密钥或离线开发返回固定字段。
- `src/main/ai/prompt.ts`: 统一的词卡生成提示文案，约束字段格式与语气。
- `src/main/ai/types.ts`: provider、配置与生成字段类型定义。
- `src/main/ai/utils.ts`: term 校验、字段解析、超时控制等通用工具。
- `src/main/ipc/handlers.ts`: IPC 频道处理器，校验入参并调度 DataStore、SM-2 队列与 AI provider；支持导入/导出路径校验。
- `src/main/ipc/provider.ts`: 管理 AI provider 配置与实例的状态，合并超时/密钥来源，保证密钥仅在主进程使用。
- `src/main/ipc/index.ts`: 注册/卸载 ipcMain handlers，便于测试注入与生命周期管理。
- `src/main/storage/index.ts`: 主进程数据入口，提供 `createDataStore` 以读写 `words.json`/`activity.json`，支持新增/更新/删除词条、按评分应用 SM-2 更新并累计活跃度，返回 streak 与今日统计；新增导入/导出 JSON 与 CSV 的接口。
- `src/main/storage/json.ts`: 封装 JSON 读写与原子写入（临时文件 + rename），出现错误时清理临时文件避免污染。
- `src/main/storage/paths.ts`: 解析默认数据目录 `data/`，提供 `getWordsPath`/`getActivityPath`。
- `src/main/storage/words.ts`: 构建词条草稿为完整 `Word`，合并更新时补全 `updated_at` 与 SM-2 字段。
- `src/main/storage/activity.ts`: 活跃度工具，递增每日新增/复习计数、计算连续活跃天数（按 UTC 日期），汇总今日统计。
- `src/main/storage/transfer.ts`: 导入/导出辅助，解析外部 words/activity 文件、按 term 去重合并并生成 CSV。
- `src/main/storage/types.ts`: 存储层专用类型（词条草稿/更新、活跃度汇总）。
- `src/preload/index.ts`: 预加载脚本，占位暴露 `electronAPI`，后续可按需扩展受控桥接。
- `src/renderer/main.tsx`: React 入口，挂载根组件并启用 StrictMode。
- `src/renderer/store.ts`: 渲染端全局 Zustand store，集中管理词库、复习队列、活跃度、provider 与 session 状态，封装调用 IPC 的异步 actions。
- `src/renderer/App.tsx`: 渲染占位页面，后续 UI 将在此拓展。
- `src/renderer/electron-api.d.ts`: 声明 window.electronAPI 类型，渲染端只能调用白名单 IPC API。
- `src/shared/index.ts`: 汇总导出 shared 模块。
- `src/shared/types.ts`: 词条、SM-2 状态、复习日志与活跃度数据的共享类型。
- `src/shared/ai.ts`: 跨端共享的 provider 名称、状态与词卡字段类型。
- `src/shared/ipc.ts`: IPC 频道常量、请求/响应契约与 Renderer API 类型。
- `src/shared/data-transfer.ts`: 导入/导出请求与结果类型定义，覆盖 JSON/CSV 路径与统计字段。
- `src/shared/sm2.ts`: SM-2 默认状态、评分更新、到期判断与复习队列排序的纯函数。
- `src/shared/validation.ts`: 词条/活跃度 JSON 校验与默认值补全（时间戳、SM-2 下限夹紧）。
- `src/__test__/sm2.test.ts`: 覆盖 SM-2 算法与复习队列排序的 Vitest 用例。
- `src/__test__/validation.test.ts`: 覆盖词条与活跃度补全校验的 Vitest 用例。
- `src/__test__/storage.test.ts`: 基于临时目录的存储层单测，验证原子写入、防坏数据补全、SM-2 评分更新、活跃度累积与导入/导出。
- `src/__test__/ai-providers.test.ts`: 覆盖 OpenAI/Gemini/Mock provider 的字段解析、超时与默认分支。
- `src/__test__/store.test.ts`: 渲染端 store 的 Vitest 用例，mock electronAPI 覆盖加载/错误、词条增改删、评分更新队列与 provider/活跃度刷新。
- `prompts/`: 约束开发流程的全局提示集合（coding-principles、system-prompt），变更行为需遵循此处规则。
- `memory-bank/`: 项目设计与进度文档中心（设计文档、技术栈、实施计划、架构说明、UI 设计、进度记录）。
- `AGENTS.md`: 代码助手的操作规范与技能列表。

## 当前架构要点
- Electron + Vite 基础骨架已跑通：`npm run dev` 启动空白窗口，`npm run build` 打包 renderer/main/preload 并生成 electron-builder 目录。
- 主进程采用 ESM 输出，避免 CJS/ESM 混用导致的加载警告；预加载保持 CJS 以兼容 contextBridge 暴露。
- 构建产物分层存放（renderer 与 electron 独立目录），为后续主/渲染进程扩展与测试隔离打基础。
- 密钥与依赖隔离：通过 `.env.local` 与 `.gitignore` 避免敏感信息入库，锁文件保证团队一致性。
- 代码风格守护：已接入 ESLint flat 配置与 Prettier，`npm run lint` 作为统一入口保证 TypeScript/React 代码和配置文件风格一致。
- 文档优先：prompts 与 memory-bank 构成规则与设计的单一可信来源，后续模块与代码需按其约束演进。
- 共享逻辑与测试：`src/shared` 集中提供 SM-2 算法、类型与数据校验，`src/__test__` 通过 Vitest 覆盖核心公式与默认补全，确保主/渲染进程复用时行为一致。
- 主进程存储层：`src/main/storage` 采用 JSON 原子写入与严格校验，封装词条与活跃度的读写更新，确保 SM-2 更新与活跃度累积一致且写入失败不破坏原文件。
- AI 提供商适配：`src/main/ai` 统一封装 OpenAI/Gemini/Mock，集中提示、字段解析与超时控制，默认走 mock 以便无密钥开发，由 IPC 层安全暴露。
- IPC 安全桥接：`src/shared/ipc.ts` 定义频道与契约，`src/main/ipc` 校验入参并调度 DataStore/AI，`src/preload` 只暴露白名单 API，减少渲染进程能力面。
