# 计划：AI 生成与 Provider 抽象

## 计划概述

### 计划目标
设计并实现统一的 AI Provider 抽象，支持基于单词生成假名、情景化解释、场景描述与例句的能力，包含配置、降级与审计。

### 在项目中的位置
为今日学习、词库重生成和后续扩展提供可插拔的生成服务，主进程 API 经此调用外部模型。

---

## 依赖关系

### 前置条件
- 前置任务：plan_03 - 主进程 API 与基础服务
- 前置数据：生成字段需求与内容规范
- 前置环境：可用的模型密钥配置与网络访问

### 后续影响
- 后续任务：plan_07 - 今日学习流；plan_09 - 词库管理
- 产出数据：Provider 抽象、提示模板、调用策略

---

## 子任务分解
**每一个子任务都必须小而具体**

- sub_plan_01 - 定义生成契约
  - 简述：约定输入输出字段、长度要求与语气风格
- sub_plan_02 - 设计 Provider 抽象层
  - 简述：定义统一接口，支持多 Provider 插拔与扩展
- sub_plan_03 - 实现默认 Provider 适配
  - 简述：封装调用参数、错误处理、重试与超时
- sub_plan_04 - 配置管理与安全
  - 简述：环境变量读取、必填校验、敏感信息隔离
- sub_plan_05 - 内容过滤与审计
  - 简述：添加基本安全检查、日志与失败降级策略
- sub_plan_06 - 性能与费用控制
  - 简述：请求合并、速率限制与重生成开关

---

## 技术方案

### 架构设计
主进程内的服务层封装 Provider，暴露统一方法供 API 调用，支持多实现与降级路径；提示模板与参数集中管理。

### 核心技术选型
- 可插拔 Provider 抽象：面向接口编程，便于后续扩展
- 环境变量配置：.env.local 管理密钥与模型参数

### 数据模型
生成请求字段：word、阅读风格偏好、长度与语气约束；生成结果字段：reading、context_expl、scene_desc、example，以及关联的创建时间与来源标记。

### 接口设计
提供生成、重生成接口；支持批量或单次调用，返回统一结构并附错误码与提示信息。

---

## 执行摘要

### 输入
- 用户输入的单词与偏好设置
- Provider 密钥与模型配置

### 处理
- 构造提示、调用 Provider、解析响应
- 失败时降级或提示用户重试

### 输出
- 生成的 reading、context_expl、scene_desc、example
- 调用日志与错误信息

---

## 验收标准
**验收标准必须清晰明确**

### 功能验收
- 生成接口可返回四个目标字段，长度与语气符合约束
- 支持至少一种 Provider，缺省配置时给出明确错误
- 失败与超时具备重试或降级提示

### 质量验收
- 密钥不出现在日志与响应
- 抽象层可扩展第二个 Provider 而无需改动调用方

---

## 交付物清单

### 代码文件
- Provider 抽象与默认实现：1 套

### 配置文件
- 模型与密钥配置说明：1 份

### 文档
- 提示模板与调用策略说明：1 份

### 测试文件
- 生成接口测试计划：1 份
