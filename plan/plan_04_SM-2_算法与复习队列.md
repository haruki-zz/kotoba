# 计划：SM-2 算法与复习队列

## 计划概述

### 计划目标
实现符合设计规则的 SM-2 评分与调度逻辑，构建复习队列生成、结果提交、回退与统计更新能力。

### 在项目中的位置
为复习页、统计反馈与词条调度提供核心算法与数据更新支撑。

---

## 依赖关系

### 前置条件
- 前置任务：plan_02 - 数据模型与数据库；plan_03 - 主进程 API 与基础服务
- 前置数据：words 表字段，掌握度映射规则
- 前置环境：时间与日期处理库可用

### 后续影响
- 后续任务：plan_08 - 复习流；plan_10 - 统计与反馈
- 产出数据：队列生成逻辑、复习结果写入与回退策略

---

## 子任务分解
**每一个子任务都必须小而具体**

- sub_plan_01 - 定义评分与状态转换
  - 简述：梳理 easy/medium/hard 与 q 值映射、EF 更新与间隔计算
- sub_plan_02 - 构建队列生成策略
  - 简述：按 next_due_at 升序截取队列，支持可配置长度
- sub_plan_03 - 实现结果提交与持久化
  - 简述：根据评分更新 ef、interval_days、repetition、last_review_at、next_due_at
- sub_plan_04 - 实现回退与撤销
  - 简述：保存最近一次提交上下文，支持一步撤销并回滚字段
- sub_plan_05 - 更新统计指标
  - 简述：在提交后更新掌握度分布与进度相关计数
- sub_plan_06 - 定义时间与幂等策略
  - 简述：统一时间戳格式、处理重复提交与空队列情况

---

## 技术方案

### 架构设计
独立的算法模块提供纯函数计算，复习服务组合数据访问实现入队、出队与回退，避免直接耦合渲染端。

### 核心技术选型
- 纯 TypeScript 算法模块：易测且与 UI 解耦
- 时间处理库：确保时区与 ISO 输出一致

### 数据模型
使用 words 表字段 ef、interval_days、repetition、last_review_at、next_due_at，新增内存态的队列缓存结构（列表、当前指针、历史栈）。

### 接口设计
提供算法与服务接口：生成队列、获取当前项、提交评分、撤销上一步、获取进度状态；主进程暴露对应 API。

---

## 执行摘要

### 输入
- 词条数据与 SM-2 规则
- 队列长度配置与当前时间

### 处理
- 生成队列并按需缓存
- 计算评分结果并更新持久化
- 支持回退与统计同步更新

### 输出
- 新的队列状态与持久化数据
- 更新后的统计指标

---

## 验收标准
**验收标准必须清晰明确**

### 功能验收
- easy/medium/hard 对应 q=5/4/3，EF 更新符合公式且下限 1.3
- 队列按 next_due_at 升序截取指定数量
- 提交与回退均可更新 ef、interval_days、repetition、last_review_at、next_due_at
- 空队列返回友好提示，不阻塞流程

### 质量验收
- 算法模块具备单元测试覆盖主要分支
- 时间处理一致，重复提交具备幂等保护

---

## 交付物清单

### 代码文件
- 算法与队列服务约定：1 套

### 配置文件
- 队列长度与时间配置说明：1 份

### 文档
- 评分与调度规则说明：1 份

### 测试文件
- 算法单元测试计划：1 份
