# 计划：Fastify API 与数据访问层

## 计划概述

### 计划目标
构建本地 API 层，提供词条 CRUD、调度更新、批量导入、搜索过滤与统计等接口，并封装数据访问逻辑；在无前端或仅基础界面下即可完成端到端验证。

### 在项目中的位置
位于主进程侧，承上（渲染层调用）启下（数据库存储与调度核心），承担数据与业务规则的网关角色。

---

## 依赖关系

### 前置条件
- **前置任务**：plan_02 - 数据库与数据模型设计；plan_03 - SM-2 调度核心；plan_01 - 环境与基础框架搭建
- **前置数据**：模式定义与调度函数
- **前置环境**：主进程运行环境、类型共享可用

### 后续影响
- **后续任务**：plan_05 - AI 辅助功能与提示工程；plan_06 - Electron 主进程与应用壳；plan_07 - 渲染层体验
- **产出数据**：API 规范、路由实现、数据访问封装

---

## 子任务分解
**每一个子任务都必须小而具体**

- sub_plan_01 - 路由设计与契约
  - 简述：定义 CRUD、调度、搜索、批量导入、统计等路由与模式校验
- sub_plan_02 - 数据访问封装
  - 简述：实现对数据层的抽象调用，处理事务与错误映射
- sub_plan_03 - 调度集成
  - 简述：将评分请求接入调度核心并落库
- sub_plan_04 - 输入输出校验
  - 简述：使用共享模式对请求/响应进行校验与序列化
- sub_plan_05 - 日志与错误处理
  - 简述：定义统一错误格式、日志级别与性能度量占位
- sub_plan_06 - 测试与契约验证
  - 简述：编写 API 层测试与模式契约验证
- sub_plan_07 - 无界面验收通路
  - 简述：提供脚本或 API 测试集合，在无前端或最小界面下完成新增词条、评分、调度更新的端到端验证

---

## 技术方案

### 架构设计
Fastify 插件化路由 + 中间件层，数据访问通过抽象服务模块调用数据库；校验与类型由共享模式生成。

### 核心技术选型
- **技术1**：Fastify 插件化路由
- **技术2**：共享模式驱动的校验与序列化

### 数据模型
复用计划中的共享模式；API 层增加分页、过滤、排序参数的类型描述。

### 接口设计
涵盖增删改查、调度更新、批量导入、搜索过滤、统计汇总；统一前缀与版本策略；错误码与消息格式一致。

---

## 执行摘要

### 输入
- 渲染层或主进程的调用请求
- 数据层访问能力与调度核心

### 处理
- 校验请求
- 调用调度或数据操作
- 返回标准化响应

### 输出
- API 响应数据
- 可供渲染层或脚本消费的序列化结构

---

## 验收标准
**验收标准必须清晰明确**

### 功能验收
- CRUD、调度更新、搜索与统计接口可用并返回符合模式的响应
- 错误处理统一，非法输入被拦截
- 可在无前端或最小界面下，通过 API/脚本完成新增、评分、调度更新的端到端验证

### 质量验收
- 请求/响应模式与共享定义一致
- 单元与集成测试覆盖主要路由与错误分支
- 日志输出可追踪关键操作

---

## 交付物清单

### 代码文件
- API 路由与插件实现：覆盖全部目标接口
- 数据访问封装模块

### 配置文件
- API 启动配置、端口与限流占位

### 文档
- 路由与参数说明
- 错误码与响应格式说明

### 测试文件
- API 层测试与无界面端到端验证集合
