# 计划：SM-2 调度核心

## 计划概述

### 计划目标

实现可配置的 SM-2 调度逻辑，支持评分、重复次数、间隔、EF 更新与下次到期时间计算，并提供测试覆盖。

### 在项目中的位置

位于业务核心层，为 API 与渲染层提供稳定的复习计划与调度结果。

---

## 依赖关系

### 前置条件

- **前置任务**：plan_02 - 数据库与数据模型设计
- **前置数据**：调度字段定义、评分标准
- **前置环境**：共享类型可用

### 后续影响

- **后续任务**：plan_04 - Fastify API 与数据访问层；plan_07 - 渲染层体验
- **产出数据**：调度计算模块、配置接口、单元测试

---

## 子任务分解

**每一个子任务都必须小而具体**

- sub_plan_01 - 评分与状态机定义
  - 简述：确定评分区间、失败重置规则与状态机
- sub_plan_02 - 间隔与 EF 更新逻辑
  - 简述：实现 EF 公式、最小值约束与间隔推导
- sub_plan_03 - 下次到期时间计算
  - 简述：计算 next_due_at，考虑时区与时间源
- sub_plan_04 - 配置化与可调参数
  - 简述：提炼可配置参数（初始 EF、最小间隔、上限等）
- sub_plan_05 - 纯函数与测试
  - 简述：以纯函数方式实现并编写高覆盖率测试与边界案例

---

## 技术方案

### 架构设计

采用纯函数核心 + 配置注入，输入当前调度状态与评分，输出新的调度状态；保持无副作用，便于测试与重用。

### 核心技术选型

- **技术1**：TypeScript 纯函数实现
- **技术2**：测试框架与时间模拟工具

### 数据模型

输入包含 EF、间隔、重复次数、时间戳与评分；输出包含更新后的调度字段与到期时间。

### 接口设计

暴露单一调度计算接口与参数配置接口；可选提供批量计算入口供列表复习使用。

---

## 执行摘要

### 输入

- 当前卡片调度状态
- 用户评分
- 可选的配置参数

### 处理

- 评分映射到状态机
- EF 与间隔更新
- 生成下一次到期时间

### 输出

- 更新后的调度结果
- 供存储的状态对象

---

## 验收标准

**验收标准必须清晰明确**

### 功能验收

- 评分为低于阈值时复位逻辑正确
- 连续复习间隔按 SM-2 规则增长并受配置约束
- 计算结果可直接写入数据库字段

### 质量验收

- 覆盖率包含正常与边界评分、时间漂移、最小/最大间隔
- 核心函数无副作用、幂等于同输入
- 类型定义与共享模式一致

---

## 交付物清单

### 代码文件

- 调度核心模块：纯函数实现与配置定义

### 配置文件

- 调度默认参数配置占位

### 文档

- 调度规则说明与参数含义
- 用例示例描述（无具体代码）

### 测试文件

- 单元测试：覆盖评分分支、EF 计算、时间计算
