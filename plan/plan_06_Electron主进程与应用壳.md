# 计划：Electron 主进程与应用壳

## 计划概述

### 计划目标

构建主进程应用壳，负责窗口管理、生命周期、协议注册、IPC 桥接以及与 API 层的集成。

### 在项目中的位置

处于应用入口层，连接操作系统能力与渲染层，承载安全沙箱与 IPC 通道。

---

## 依赖关系

### 前置条件

- **前置任务**：plan_01 - 环境与基础框架搭建；plan_04 - Fastify API 与数据访问层
- **前置数据**：API 端点定义、IPC 需求
- **前置环境**：Electron 运行环境

### 后续影响

- **后续任务**：plan_07 - 渲染层体验；plan_09 - 设置与偏好
- **产出数据**：主进程壳层、IPC 通道、预加载桥接

---

## 子任务分解

**每一个子任务都必须小而具体**

- sub_plan_01 - 窗口与生命周期管理
  - 简述：配置窗口创建、最小化/关闭策略、单实例锁
- sub_plan_02 - 安全与沙箱设置
  - 简述：启用上下文隔离、内容安全策略、协议限制
- sub_plan_03 - 预加载与 IPC 桥接
  - 简述：定义安全的 IPC 通道，将 API 调用暴露给渲染层
- sub_plan_04 - 日志与崩溃处理
  - 简述：集成日志、崩溃捕获与恢复指引
- sub_plan_05 - 主进程与 API 集成
  - 简述：启动 Fastify 服务并协调生命周期

---

## 技术方案

### 架构设计

主进程负责窗口与安全配置；预加载层暴露受限 API；通过 IPC 调用本地 Fastify 服务或直接访问数据层。

### 核心技术选型

- **技术1**：Electron 主进程与预加载脚本
- **技术2**：安全配置（上下文隔离、协议限制、CSP）

### 数据模型

不新增业务模型；使用共享类型定义 IPC 数据契约。

### 接口设计

定义 IPC 通道名称、请求/响应结构、错误格式；必要时提供主进程事件订阅接口。

---

## 执行摘要

### 输入

- API 端点或数据访问接口
- 渲染层对系统能力的需求

### 处理

- 初始化窗口与安全策略
- 建立 IPC 桥接
- 协调服务启动与关闭

### 输出

- 可运行的桌面壳层
- 安全隔离的预加载接口

---

## 验收标准

**验收标准必须清晰明确**

### 功能验收

- 应用可启动单实例，窗口创建正常
- IPC 通道可调用 API 并返回结果
- 预加载层启用上下文隔离与安全限制

### 质量验收

- 基础安全检查通过（CSP、禁用不必要的 Node 集成）
- 主进程日志包含关键生命周期事件
- 崩溃处理路径可触发并记录

---

## 交付物清单

### 代码文件

- 主进程入口与配置
- 预加载与 IPC 桥接模块

### 配置文件

- 安全策略与窗口参数配置

### 文档

- 启动流程说明与 IPC 契约

### 测试文件

- 主进程与 IPC 冒烟测试占位
