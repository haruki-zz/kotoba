# 计划：AI 辅助功能与提示工程

## 计划概述

### 计划目标
集成 AI 能力用于例句生成、释义补全、难度评估或学习建议，设计提示模板与调用流程，确保可控与可回退。

### 在项目中的位置
作为增强层，为内容创建与学习体验提供辅助；与 API 层、渲染层协同。

---

## 依赖关系

### 前置条件
- **前置任务**：plan_02 - 数据库与数据模型设计；plan_03 - SM-2 调度核心；plan_04 - Fastify API 与数据访问层
- **前置数据**：词条与上下文信息
- **前置环境**：环境变量与密钥管理可用

### 后续影响
- **后续任务**：plan_07 - 渲染层体验；plan_08 - Library 与内容管理
- **产出数据**：提示模板、调用管线、结果存储策略

---

## 子任务分解
**每一个子任务都必须小而具体**

- sub_plan_01 - 能力与范围定义
  - 简述：确认支持的 AI 场景（例句、释义、难度、复习提示等）
- sub_plan_02 - 提示模板设计
  - 简述：编写可参数化的提示模板，覆盖安全与风格约束
- sub_plan_03 - 调用与供应商抽象
  - 简述：实现供应商无关的调用层，支持多提供方切换
- sub_plan_04 - 数据流与持久化
  - 简述：决定生成结果的写入方式、版本与追踪字段
- sub_plan_05 - 速率与错误处理
  - 简述：设置速率限制、重试、超时与降级策略
- sub_plan_06 - 前端交互与反馈
  - 简述：设计调用触发、加载状态、失败提示与手动编辑回退

---

## 技术方案

### 架构设计
供应商抽象层 + 提示模板库 + 调度与速率控制；结果通过 API 写入数据库或返回前端，支持可选缓存。

### 核心技术选型
- **技术1**：LLM 客户端抽象（可切换提供方）
- **技术2**：提示模板与参数化注入机制

### 数据模型
扩展词条数据以存储生成内容、来源标记、版本与时间戳；记录调用日志与错误信息。

### 接口设计
提供生成、重试、撤销接口；支持批量生成与单次生成；前端通过 IPC/API 触发。

---

## 执行摘要

### 输入
- 词条内容、上下文、用户选择
- 供应商配置与密钥

### 处理
- 构造提示
- 调用 AI 服务并解析结果
- 保存或返回生成内容

### 输出
- 生成的例句、释义或建议
- 调用日志与错误反馈

---

## 验收标准
**验收标准必须清晰明确**

### 功能验收
- 至少一个 AI 场景可端到端运行并写入或展示结果
- 调用失败可重试或回退，错误信息可见
- 支持切换或配置不同提供方

### 质量验收
- 提示模板可复用且参数化，避免硬编码
- 速率限制与超时策略生效
- 日志记录请求与响应摘要，保护敏感数据

---

## 交付物清单

### 代码文件
- AI 调用抽象与供应商适配模块
- 提示模板与参数注入定义

### 配置文件
- AI 提供方与密钥的环境变量示例

### 文档
- 场景说明、提示模板规范、错误处理策略

### 测试文件
- 调用层测试：包含成功、失败、超时与重试分支
